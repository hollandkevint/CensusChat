
# Story 1.2: Live Census API Integration

## Status: Ready

## Story

**As a** healthcare analyst,
**I want** to connect to real Census API data,
**so that** I can work with current demographic information instead of mock responses.

## Acceptance Criteria

1. Replace WireMock with authenticated Census Bureau API connection
2. Implement rate limiting to stay within Census API quotas
3. Cache frequently requested datasets in Redis with 1-hour TTL
4. Maintain existing response format for frontend compatibility
5. Provide clear feedback when API limits are reached

## Tasks / Subtasks

- [ ] Task 1: Census API Authentication Setup (AC: 1)
  - [ ] Obtain Census Bureau API credentials and configure environment variables
  - [ ] Implement Census API authentication service with proper key management
  - [ ] Create CensusApiClient class with authentication headers
  - [ ] Add configuration validation for required API credentials
  - [ ] Test authentication with Census API endpoints

- [ ] Task 2: Replace WireMock with Live API (AC: 1, 4)
  - [ ] Identify all WireMock endpoints currently in use
  - [ ] Create Census API integration layer to replace WireMock responses
  - [ ] Maintain exact response format compatibility for existing frontend
  - [ ] Implement feature flag to toggle between WireMock and live API
  - [ ] Update API service calls to use live Census API

- [ ] Task 3: Rate Limiting Implementation (AC: 2, 5)
  - [ ] Research Census API rate limits and usage quotas
  - [ ] Implement rate limiting middleware using existing Redis infrastructure
  - [ ] Add request throttling and queue management
  - [ ] Create user-friendly error messages for rate limit scenarios
  - [ ] Add monitoring for API usage and quota tracking

- [ ] Task 4: Redis Caching Strategy (AC: 3)
  - [ ] Design cache key strategy for Census data requests
  - [ ] Implement intelligent caching with 1-hour TTL for frequently accessed data
  - [ ] Create cache invalidation strategy for data freshness
  - [ ] Add cache hit/miss metrics for performance monitoring
  - [ ] Optimize memory usage with cache size limits

- [ ] Task 5: Error Handling and Fallback (AC: 4, 5)
  - [ ] Implement graceful degradation when Census API is unavailable
  - [ ] Create fallback to cached data when API limits are reached
  - [ ] Add comprehensive error logging and monitoring
  - [ ] Maintain user experience with appropriate error messages
  - [ ] Test all error scenarios and edge cases

- [ ] Task 6: Testing and Validation (AC: 1-5)
  - [ ] Write unit tests for Census API integration
  - [ ] Create integration tests with live API (using test credentials)
  - [ ] Test rate limiting and caching functionality
  - [ ] Verify response format compatibility
  - [ ] Performance testing with Redis caching enabled

## Dev Notes

### Previous Story Insights
**Key Dependencies from Story 1.1 [Source: docs/stories/1.1.story.md]**:
- Backend API endpoint `/api/v1/queries` will be established in Story 1.1
- AnthropicService integration provides the foundation for query processing
- Response format contracts must be maintained for frontend compatibility
- Error handling patterns from Story 1.1 should be extended for Census API failures

### API Specifications
**Census Bureau API Integration [Source: docs/API_INTEGRATION_GUIDE.md]**:
- **Base URL**: `https://api.census.gov/data/`
- **Authentication**: API key required in query parameters (`?key={API_KEY}`)
- **Rate Limits**: 500 requests per IP address per day (standard tier)
- **Response Format**: JSON with standardized Census data structure
- **Primary Datasets**: American Community Survey (ACS) 5-Year estimates

**Response Format Compatibility [Source: docs/API_INTEGRATION_GUIDE.md]**:
- Must maintain existing response structure for frontend compatibility
- Response format: `{ success: boolean, message: string, data: array, metadata: object }`
- Metadata must include: `queryTime`, `totalRecords`, `dataSource`, `confidenceLevel`, `marginOfError`

### Data Models
**Census API Response Structure**:
```typescript
interface CensusApiResponse {
  data: CensusRecord[];
  metadata: {
    dataset: string;
    vintage: number;
    geography: string;
    variables: { [key: string]: string };
  };
}

interface CensusRecord {
  [variable: string]: string | number;
  geography: string;
  state?: string;
  county?: string;
}
```

**Cache Strategy Model**:
```typescript
interface CacheKey {
  endpoint: string;
  parameters: Record<string, any>;
  hash: string;
}

interface CachedResponse {
  data: any;
  timestamp: number;
  ttl: number;
  source: 'census-api' | 'cache';
}
```

### Component Specifications
**WireMock Current Implementation [Source: project analysis]**:
- **Current Mock Location**: `/test-data/wiremock/mappings/census-basic.json`
- **Mock Endpoints**: Health check, basic demographics, geography queries
- **Response Patterns**: Consistent with ACS 2022 5-Year data structure
- **Integration Point**: Service virtualization in Docker test environment

**Redis Infrastructure [Source: docs/architecture/01-system-architecture.md]**:
- **Configuration**: Redis Cluster with automatic failover
- **Memory**: Optimized for large result sets with TTL policies
- **Performance**: <100ms cache retrieval times
- **Availability**: Redis Sentinel for high availability

### File Locations
**Backend Integration Points**:
- **Services**: `/backend/src/services/censusApiService.ts` - New Census API integration service
- **Config**: `/backend/src/config/censusApi.ts` - API configuration and credentials
- **Cache**: `/backend/src/services/cacheService.ts` - Redis caching layer (extend existing)
- **Middleware**: `/backend/src/middleware/rateLimiting.ts` - Rate limiting implementation
- **Routes**: Update existing `/backend/src/routes/queries.ts` to use live API

**Environment Configuration**:
- **API Credentials**: `CENSUS_API_KEY` environment variable
- **Feature Flags**: `USE_LIVE_CENSUS_API` boolean flag
- **Cache Settings**: `CENSUS_CACHE_TTL` configuration (default 3600 seconds)
- **Rate Limits**: `CENSUS_API_REQUESTS_PER_HOUR` configuration

### Technical Constraints
**API Performance Requirements [Source: docs/architecture/01-system-architecture.md]**:
- **Response Time**: <3 seconds for 95% of Census API requests
- **Cache Hit Rate**: >70% for repeated queries
- **Error Rate**: <0.1% failed requests under normal load
- **Availability**: Graceful degradation when Census API unavailable

**Rate Limiting Strategy [Source: docs/architecture/02-microservices-architecture.md]**:
- **Per-User Limits**: Implement user-based rate limiting
- **System Limits**: Respect Census API quotas system-wide
- **Queue Management**: Request queuing for burst scenarios
- **Monitoring**: Track usage patterns and optimize limits

### Security Considerations
**API Key Management**:
- Secure storage of Census API credentials in environment variables
- No API keys in source code or logs
- Rotation strategy for API credentials
- Access logging for security auditing

**Data Privacy**:
- Census data is public but must respect terms of use
- No personally identifiable information (PII) handling
- Comply with Census Bureau data usage policies
- Audit trail for all API requests

### Error Scenarios and Handling
**Census API Failure Modes**:
1. **Authentication Errors**: Invalid or expired API key
2. **Rate Limit Exceeded**: Daily or hourly quota reached
3. **Service Unavailable**: Census API downtime or maintenance
4. **Invalid Requests**: Malformed geography or variable codes
5. **Timeout Errors**: Slow Census API responses

**Fallback Strategies**:
- **Cached Data**: Serve cached responses when API unavailable
- **WireMock Fallback**: Option to fall back to mock data during outages
- **Partial Data**: Return partial results when some queries fail
- **User Messaging**: Clear communication about data availability

### Testing Requirements
**Testing Standards**:
- **Integration Testing**: Live Census API calls with test credentials
- **Cache Testing**: Redis integration and TTL functionality
- **Rate Limiting**: Throttling and queue behavior validation
- **Error Testing**: All failure scenarios and fallback mechanisms
- **Performance Testing**: Response times with caching enabled

**Test Environment Configuration**:
- **Test API Key**: Separate Census API credentials for testing
- **Mock Toggle**: Ability to switch between live and mock data
- **Cache Reset**: Test data cleanup between test runs
- **Rate Limit Testing**: Controlled rate limit scenarios

## Testing

### Testing Standards
**Backend Testing Framework [Source: project structure analysis]**:
- **Framework**: Jest (maintain 89% success rate)
- **Integration Tests**: `/backend/src/__tests__/integration/censusApi.test.ts`
- **Service Tests**: `/backend/src/__tests__/services/censusApiService.test.ts`
- **Cache Tests**: `/backend/src/__tests__/services/cacheService.test.ts`

**Specific Testing Requirements**:
- **Live API Testing**: Integration tests with actual Census API
- **Rate Limiting**: Validate throttling behavior and error responses
- **Caching Logic**: Test cache hits, misses, and TTL expiration
- **Error Handling**: All failure modes and fallback scenarios
- **Performance**: Response time requirements with Redis caching

**Environment Setup**:
- **Test Credentials**: Census API test key configuration
- **Redis Test Instance**: Isolated cache for testing
- **Feature Flags**: Toggle testing between mock and live data
- **Test Data**: Controlled datasets for consistent testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation for live Census API integration | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA Agent after story implementation*