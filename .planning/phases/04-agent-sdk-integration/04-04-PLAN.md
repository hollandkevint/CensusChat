---
phase: 04-agent-sdk-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/package-lock.json
  - backend/src/agent/agentSdkService.ts
  - backend/src/agent/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "@anthropic-ai/claude-agent-sdk package installed and importable"
    - "agentSdkService.ts uses Agent SDK query() function"
    - "Agent SDK configured to connect to MCP server via HTTP"
  artifacts:
    - path: "backend/src/agent/agentSdkService.ts"
      provides: "Agent SDK wrapper with MCP connection"
      min_lines: 80
      exports: ["AgentSdkService", "queryWithAgentSdk"]
    - path: "backend/package.json"
      provides: "@anthropic-ai/claude-agent-sdk dependency"
      contains: "@anthropic-ai/claude-agent-sdk"
  key_links:
    - from: "backend/src/agent/agentSdkService.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "import { query }"
      pattern: 'import.*query.*from.*claude-agent-sdk'
    - from: "backend/src/agent/agentSdkService.ts"
      to: "MCP server"
      via: "mcpServers option"
      pattern: 'mcpServers.*type.*http'
---

<objective>
Install @anthropic-ai/claude-agent-sdk and create agentSdkService.ts wrapper that uses the Agent SDK's query() function with MCP HTTP connection.

Purpose: Close Gap 1 from VERIFICATION.md - Phase 4 is titled "Agent SDK Integration" but the Agent SDK was never installed. This is the foundational unblocking step.

Output: New agentSdkService.ts that can be used alongside or instead of the existing base SDK agentService.ts via feature flag.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-sdk-integration/04-RESEARCH.md
@.planning/phases/04-agent-sdk-integration/04-01-SUMMARY.md
@.planning/phases/04-agent-sdk-integration/04-VERIFICATION.md

# Existing files to reference
@backend/src/agent/agentService.ts
@backend/src/agent/mcpConfig.ts
@backend/src/agent/schemas/queryResponse.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Agent SDK and create wrapper service</name>
  <files>
    backend/package.json
    backend/src/agent/agentSdkService.ts
    backend/src/agent/index.ts
  </files>
  <action>
1. Install the Agent SDK:
   ```bash
   cd backend && npm install @anthropic-ai/claude-agent-sdk
   ```

2. Create `backend/src/agent/agentSdkService.ts` with:
   - Import `query` from `@anthropic-ai/claude-agent-sdk`
   - Import existing schemas from `./schemas`
   - Import MCP config from `./mcpConfig`

   Implement `queryWithAgentSdk()` function:
   ```typescript
   export async function queryWithAgentSdk(
     prompt: string,
     options?: AgentSdkOptions
   ): Promise<AgentSdkResult> {
     const mcpConfig = getMcpConfig();

     for await (const message of query({
       prompt,
       options: {
         mcpServers: {
           censuschat: {
             type: "http",
             url: mcpConfig.url,
             headers: { "Content-Type": "application/json" }
           }
         },
         allowedTools: CENSUS_TOOLS.map(t => `mcp__censuschat__${t}`),
         permissionMode: "acceptEdits"
       }
     })) {
       // Handle message types: system (init), assistant, result
       if (message.type === "system" && message.subtype === "init") {
         sessionId = message.session_id;
       }
       if (message.type === "result" && message.subtype === "success") {
         return { success: true, result: message.result, sessionId };
       }
     }
   }
   ```

   Implement `AgentSdkService` class with:
   - Constructor taking optional model, userId
   - `query()` method that calls queryWithAgentSdk
   - Session ID tracking for resumption
   - Fallback error handling

3. Export from `backend/src/agent/index.ts`:
   - Add export for AgentSdkService and queryWithAgentSdk
   - Keep existing exports (AgentService, schemas, etc.)

IMPORTANT: This creates a PARALLEL service, not replacing agentService.ts. The existing code continues to work. Feature flag USE_AGENT_SDK will route to the appropriate service.
  </action>
  <verify>
    - `npm list @anthropic-ai/claude-agent-sdk` shows installed version
    - `cat backend/src/agent/agentSdkService.ts | grep "import.*query.*claude-agent-sdk"` returns match
    - `cat backend/src/agent/agentSdkService.ts | grep "mcpServers"` returns match
    - TypeScript compiles: `cd backend && npx tsc --noEmit src/agent/agentSdkService.ts`
  </verify>
  <done>
    Agent SDK package installed. agentSdkService.ts created with query() import and MCP HTTP configuration. Exports available from index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for Agent SDK service</name>
  <files>
    backend/src/__tests__/agent/agentSdkService.test.ts
  </files>
  <action>
Create `backend/src/__tests__/agent/agentSdkService.test.ts` with:

1. Mock the Agent SDK query function:
   ```typescript
   jest.mock("@anthropic-ai/claude-agent-sdk", () => ({
     query: jest.fn()
   }));
   ```

2. Test cases:
   - Test that AgentSdkService creates instance with default options
   - Test that query() calls the Agent SDK query with MCP config
   - Test that session ID is captured from init message
   - Test error handling when query fails

3. Verify MCP configuration:
   - Test that mcpServers includes censuschat with type: "http"
   - Test that allowedTools includes expected MCP tools
   - Test that URL defaults to localhost:3001/mcp or uses MCP_SERVER_URL env

Note: These are unit tests with mocks. Integration tests requiring actual Agent SDK runtime will be separate.
  </action>
  <verify>
    - `cd backend && npm test -- --testPathPattern=agentSdkService --passWithNoTests`
    - Tests should pass with mocked Agent SDK
  </verify>
  <done>
    Unit tests verify Agent SDK service configuration, MCP setup, and session tracking. All tests pass with mocks.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Package verification:
   ```bash
   cd backend && npm list @anthropic-ai/claude-agent-sdk
   ```
   Should show installed version (0.2.30 or higher)

2. Import verification:
   ```bash
   cd backend && node -e "require('./dist/agent/agentSdkService.js')" 2>&1 || npx tsc src/agent/agentSdkService.ts --outDir /tmp/verify --esModuleInterop --module commonjs && node /tmp/verify/agent/agentSdkService.js
   ```
   Should not throw import errors

3. TypeScript compilation:
   ```bash
   cd backend && npx tsc --noEmit
   ```
   Should pass (ignore pre-existing errors in healthcare_analytics)

4. Grep verification:
   ```bash
   grep -l "claude-agent-sdk" backend/src/agent/*.ts
   ```
   Should return agentSdkService.ts
</verification>

<success_criteria>
- @anthropic-ai/claude-agent-sdk appears in package.json dependencies
- agentSdkService.ts imports and uses `query` from Agent SDK
- MCP HTTP configuration present with censuschat server
- Unit tests pass verifying the service structure
- Existing agentService.ts unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-sdk-integration/04-04-SUMMARY.md`
</output>
