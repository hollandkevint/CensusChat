---
phase: 04-agent-sdk-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/agent/agentService.ts
  - backend/src/agent/schemas/queryResponse.ts
  - backend/src/agent/schemas/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent SDK installed and importable"
    - "Query responses return validated JSON matching Zod schemas"
    - "Type-safe response parsing available to callers"
  artifacts:
    - path: "backend/src/agent/agentService.ts"
      provides: "Agent query wrapper with structured outputs"
      exports: ["queryWithSchema", "AgentService"]
    - path: "backend/src/agent/schemas/queryResponse.ts"
      provides: "Zod schemas for census query responses"
      exports: ["QueryResponseSchema", "QueryResponse"]
    - path: "backend/src/agent/schemas/index.ts"
      provides: "Schema barrel export"
  key_links:
    - from: "backend/src/agent/agentService.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "import { query }"
      pattern: "import.*from.*claude-agent-sdk"
    - from: "backend/src/agent/agentService.ts"
      to: "backend/src/agent/schemas/queryResponse.ts"
      via: "import and z.toJSONSchema()"
      pattern: "QueryResponseSchema"
---

<objective>
Install Claude Agent SDK and implement structured output foundation with Zod schema validation.

Purpose: Enable type-safe, validated JSON responses from Claude queries - the foundation for all Phase 4 features.
Output: agentService.ts with queryWithSchema() function that guarantees schema-compliant responses.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-agent-sdk-integration/04-RESEARCH.md
@backend/package.json
@backend/src/services/anthropicService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Agent SDK and create schema definitions</name>
  <files>
    backend/package.json
    backend/src/agent/schemas/queryResponse.ts
    backend/src/agent/schemas/index.ts
  </files>
  <action>
1. Install the Claude Agent SDK:
   ```bash
   cd backend && npm install @anthropic-ai/claude-agent-sdk
   ```

2. Create `backend/src/agent/schemas/queryResponse.ts` with Zod schema:
   ```typescript
   import { z } from "zod";

   // Schema for individual data records (flexible for census data)
   export const DataRecordSchema = z.record(z.string(), z.unknown());

   // Metadata about the query result
   export const QueryMetadataSchema = z.object({
     rowCount: z.number(),
     hasMore: z.boolean(),
     tables: z.array(z.string()),
     columns: z.array(z.string()),
     executionTimeMs: z.number().optional(),
   });

   // Main query response schema
   export const QueryResponseSchema = z.object({
     success: z.boolean(),
     data: z.array(DataRecordSchema),
     metadata: QueryMetadataSchema,
     explanation: z.string(),
     suggestedRefinements: z.array(z.string()).optional(),
   });

   // Type inference from schema
   export type QueryResponse = z.infer<typeof QueryResponseSchema>;
   export type QueryMetadata = z.infer<typeof QueryMetadataSchema>;
   ```

3. Create `backend/src/agent/schemas/index.ts` barrel export:
   ```typescript
   export * from "./queryResponse";
   ```

Note: Zod is already a dependency via @anthropic-ai/claude-agent-sdk (check if needed separately).
  </action>
  <verify>
    - `npm ls @anthropic-ai/claude-agent-sdk` shows installed version
    - `npx tsc --noEmit backend/src/agent/schemas/queryResponse.ts` compiles without errors
  </verify>
  <done>
    - Agent SDK 0.2.30+ installed in backend/package.json
    - QueryResponseSchema exported and type-infers correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agentService with structured output support</name>
  <files>
    backend/src/agent/agentService.ts
  </files>
  <action>
Create `backend/src/agent/agentService.ts` that wraps the Agent SDK query() function:

```typescript
/**
 * Agent Service - Claude Agent SDK wrapper for CensusChat
 * Provides structured output queries with schema validation
 */
import { query } from "@anthropic-ai/claude-agent-sdk";
import { z } from "zod";
import { QueryResponseSchema, QueryResponse } from "./schemas";

export interface AgentQueryOptions {
  mcpServerUrl?: string;
  sessionId?: string;
  maxTokens?: number;
}

export interface AgentQueryResult<T> {
  success: boolean;
  data?: T;
  sessionId?: string;
  error?: string;
}

/**
 * Query with structured output and schema validation
 * Uses Agent SDK's outputFormat with Zod schema
 */
export async function queryWithSchema<T extends z.ZodType>(
  prompt: string,
  schema: T,
  options: AgentQueryOptions = {}
): Promise<AgentQueryResult<z.infer<T>>> {
  const mcpServerUrl = options.mcpServerUrl || process.env.MCP_SERVER_URL || "http://localhost:3001/mcp";

  let result: AgentQueryResult<z.infer<T>> = { success: false };
  let capturedSessionId: string | undefined;

  try {
    for await (const message of query({
      prompt,
      options: {
        mcpServers: {
          censuschat: {
            type: "http",
            url: mcpServerUrl,
          },
        },
        allowedTools: [
          "mcp__censuschat__execute_query",
          "mcp__censuschat__get_information_schema",
          "mcp__censuschat__validate_sql_query",
        ],
        outputFormat: {
          type: "json_schema",
          schema: z.toJSONSchema(schema),
        },
        ...(options.sessionId && { resume: options.sessionId }),
        permissionMode: "acceptEdits", // Auto-approve in trusted backend environment
      },
    })) {
      // Capture session ID for conversational context
      if (message.type === "system" && message.subtype === "init") {
        capturedSessionId = message.session_id;
      }

      // Handle successful result with structured output
      if (message.type === "result" && message.subtype === "success") {
        if (message.structured_output) {
          const parsed = schema.safeParse(message.structured_output);
          if (parsed.success) {
            result = {
              success: true,
              data: parsed.data,
              sessionId: capturedSessionId,
            };
          } else {
            result = {
              success: false,
              error: `Schema validation failed: ${parsed.error.message}`,
              sessionId: capturedSessionId,
            };
          }
        } else {
          // Fallback: try parsing from text result
          result = {
            success: true,
            data: message.result as z.infer<T>,
            sessionId: capturedSessionId,
          };
        }
      }

      // Handle errors
      if (message.type === "result" && message.subtype === "error") {
        result = {
          success: false,
          error: message.error || "Agent query failed",
          sessionId: capturedSessionId,
        };
      }
    }
  } catch (error) {
    result = {
      success: false,
      error: error instanceof Error ? error.message : "Unknown error",
    };
  }

  return result;
}

/**
 * Convenience function for census queries with default schema
 */
export async function queryCensus(
  prompt: string,
  options: AgentQueryOptions = {}
): Promise<AgentQueryResult<QueryResponse>> {
  return queryWithSchema(prompt, QueryResponseSchema, options);
}

/**
 * AgentService class for stateful usage (maintains session across queries)
 */
export class AgentService {
  private sessionId: string | undefined;
  private mcpServerUrl: string;

  constructor(mcpServerUrl?: string) {
    this.mcpServerUrl = mcpServerUrl || process.env.MCP_SERVER_URL || "http://localhost:3001/mcp";
  }

  async query(prompt: string): Promise<AgentQueryResult<QueryResponse>> {
    const result = await queryCensus(prompt, {
      mcpServerUrl: this.mcpServerUrl,
      sessionId: this.sessionId,
    });

    // Update session ID for conversational context
    if (result.sessionId) {
      this.sessionId = result.sessionId;
    }

    return result;
  }

  getSessionId(): string | undefined {
    return this.sessionId;
  }

  clearSession(): void {
    this.sessionId = undefined;
  }
}
```

Key design decisions:
- Uses async generator iteration pattern from SDK docs
- Captures session_id for conversational context (used in Plan 03)
- schema.safeParse() for runtime validation after constrained decoding
- AgentService class maintains session across queries
- permissionMode: "acceptEdits" for trusted backend environment
  </action>
  <verify>
    - `npx tsc --noEmit backend/src/agent/agentService.ts` compiles without errors
    - Imports resolve correctly (query from SDK, schemas from local)
  </verify>
  <done>
    - agentService.ts exports queryWithSchema, queryCensus, AgentService
    - Type inference works: queryCensus returns AgentQueryResult<QueryResponse>
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit test for schema validation</name>
  <files>
    backend/src/__tests__/agent/agentService.test.ts
  </files>
  <action>
Create `backend/src/__tests__/agent/agentService.test.ts` to verify schema validation:

```typescript
/**
 * Agent Service Tests
 * Tests Zod schema validation without requiring live Agent SDK
 */
import { QueryResponseSchema, QueryResponse } from "../../agent/schemas";

describe("QueryResponseSchema", () => {
  it("validates correct response structure", () => {
    const validResponse: QueryResponse = {
      success: true,
      data: [
        { county_name: "Miami-Dade", population: 2716940 },
        { county_name: "Broward", population: 1944375 },
      ],
      metadata: {
        rowCount: 2,
        hasMore: false,
        tables: ["county_data"],
        columns: ["county_name", "population"],
      },
      explanation: "Found 2 counties in Florida",
    };

    const result = QueryResponseSchema.safeParse(validResponse);
    expect(result.success).toBe(true);
  });

  it("rejects response missing required fields", () => {
    const invalidResponse = {
      success: true,
      data: [],
      // missing metadata and explanation
    };

    const result = QueryResponseSchema.safeParse(invalidResponse);
    expect(result.success).toBe(false);
  });

  it("accepts optional suggestedRefinements", () => {
    const responseWithRefinements: QueryResponse = {
      success: true,
      data: [],
      metadata: {
        rowCount: 0,
        hasMore: false,
        tables: [],
        columns: [],
      },
      explanation: "No results found",
      suggestedRefinements: ["Try a broader search", "Include neighboring counties"],
    };

    const result = QueryResponseSchema.safeParse(responseWithRefinements);
    expect(result.success).toBe(true);
  });

  it("validates flexible data records", () => {
    const responseWithMixedData: QueryResponse = {
      success: true,
      data: [
        { county: "Test", population: 1000, rate: 0.15, active: true },
      ],
      metadata: {
        rowCount: 1,
        hasMore: false,
        tables: ["test"],
        columns: ["county", "population", "rate", "active"],
      },
      explanation: "Mixed data types in records",
    };

    const result = QueryResponseSchema.safeParse(responseWithMixedData);
    expect(result.success).toBe(true);
  });
});
```

Note: These tests validate schema logic without live Agent SDK calls. Integration tests with actual Agent SDK will be added in Plan 02 after MCP wiring is complete.
  </action>
  <verify>
    - `cd backend && npm test -- --testPathPattern=agentService` passes
  </verify>
  <done>
    - Schema validation tests pass
    - QueryResponseSchema correctly validates/rejects structures
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd backend && npm ls @anthropic-ai/claude-agent-sdk` shows 0.2.30+
2. `cd backend && npx tsc --noEmit` compiles without errors
3. `cd backend && npm test -- --testPathPattern=agentService` passes
4. File structure exists:
   - backend/src/agent/schemas/queryResponse.ts
   - backend/src/agent/schemas/index.ts
   - backend/src/agent/agentService.ts
   - backend/src/__tests__/agent/agentService.test.ts
</verification>

<success_criteria>
- Agent SDK installed (check package.json)
- Zod schemas defined with TypeScript type inference
- agentService.ts exports queryWithSchema() and AgentService
- Schema validation tests pass
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-sdk-integration/04-01-SUMMARY.md`
</output>
