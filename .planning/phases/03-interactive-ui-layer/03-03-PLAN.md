---
phase: 03-interactive-ui-layer
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - mcp-apps/src/bar-chart/index.html
  - mcp-apps/src/bar-chart/main.tsx
  - mcp-apps/src/bar-chart/BarChart.tsx
  - mcp-apps/src/line-chart/index.html
  - mcp-apps/src/line-chart/main.tsx
  - mcp-apps/src/line-chart/LineChart.tsx
  - mcp-apps/src/shared/ExportControls.tsx
  - mcp-apps/vite.config.ts
  - backend/src/mcp/mcpApps/bar-chart.html
  - backend/src/mcp/mcpApps/line-chart.html
  - backend/src/mcp/mcpServer.ts
autonomous: true

must_haves:
  truths:
    - "Bar charts render for demographic comparison queries"
    - "Line charts render for trend data"
    - "Export controls allow selecting format (CSV/Excel) and columns"
  artifacts:
    - path: "mcp-apps/src/bar-chart/BarChart.tsx"
      provides: "Recharts BarChart component"
      contains: "BarChart"
    - path: "mcp-apps/src/line-chart/LineChart.tsx"
      provides: "Recharts LineChart component"
      contains: "LineChart"
    - path: "mcp-apps/src/shared/ExportControls.tsx"
      provides: "Format and column selection UI"
      exports: ["ExportControls"]
    - path: "backend/src/mcp/mcpApps/bar-chart.html"
      provides: "Built bar chart MCP App"
      min_lines: 100
    - path: "backend/src/mcp/mcpApps/line-chart.html"
      provides: "Built line chart MCP App"
      min_lines: 100
  key_links:
    - from: "mcp-apps/src/bar-chart/BarChart.tsx"
      to: "recharts"
      via: "import"
      pattern: "from 'recharts'"
    - from: "mcp-apps/src/shared/ExportControls.tsx"
      to: "CSV download"
      via: "Blob creation"
      pattern: "new Blob"
---

<objective>
Create bar chart and line chart MCP Apps using Recharts, plus shared export controls for CSV/Excel download with column selection.

Purpose: Visualize demographic comparison and trend data with interactive charts and flexible export options.
Output: Built bar-chart.html and line-chart.html MCP Apps, ExportControls component integrated into all apps
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-interactive-ui-layer/03-RESEARCH.md
@.planning/phases/03-interactive-ui-layer/03-01-SUMMARY.md
@.planning/phases/03-interactive-ui-layer/03-02-SUMMARY.md

# Files from Plan 01 and 02
@mcp-apps/vite.config.ts
@mcp-apps/src/shared/app-bridge.ts
@mcp-apps/src/data-table/DataTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared ExportControls component</name>
  <files>
    mcp-apps/src/shared/ExportControls.tsx
    mcp-apps/src/shared/exportUtils.ts
  </files>
  <action>
**ExportControls.tsx:**
React component for in-chat export functionality.

Props:
```typescript
interface ExportControlsProps {
  data: any[];
  columns: Array<{ id: string; header: string }>;
  defaultFilename?: string;
  onExcelExport?: (data: any[]) => void;  // Delegate Excel to host
}
```

UI Layout:
1. Format selector dropdown (CSV, Excel)
2. Column picker (checkbox list, collapsible)
3. "Select All" / "Deselect All" buttons
4. Export button
5. Compact design - single row with expandable options

State:
- selectedFormat: 'csv' | 'excel'
- selectedColumns: string[] (default all)
- isColumnPickerOpen: boolean

Behavior:
- CSV export: Generate locally using exportUtils, trigger browser download
- Excel export: Send message to host via app.sendMessage({ type: 'export', format: 'excel', data, columns })
- Column picker filters data before export
- Remember column selection in session

**exportUtils.ts:**
Utility functions for export:

```typescript
export function convertToCSV(data: any[], columns: string[]): string {
  // Filter data to selected columns
  // Escape values with commas/quotes
  // Join with commas and newlines
  // Return CSV string
}

export function downloadBlob(content: string, filename: string, mimeType: string): void {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}

export function generateFilename(prefix: string, format: 'csv' | 'xlsx'): string {
  const timestamp = new Date().toISOString().slice(0, 10);
  return `${prefix}-${timestamp}.${format}`;
}
```

Styling: Use Tailwind classes for compact, professional look.
  </action>
  <verify>
```bash
ls mcp-apps/src/shared/ExportControls.tsx mcp-apps/src/shared/exportUtils.ts
grep -l "convertToCSV" mcp-apps/src/shared/exportUtils.ts
grep -l "selectedColumns" mcp-apps/src/shared/ExportControls.tsx
```
  </verify>
  <done>
ExportControls component exists with format selection, column picker, and CSV generation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Bar Chart MCP App and update Vite config</name>
  <files>
    mcp-apps/src/bar-chart/index.html
    mcp-apps/src/bar-chart/main.tsx
    mcp-apps/src/bar-chart/BarChart.tsx
    mcp-apps/vite.config.ts
  </files>
  <action>
**index.html:**
Basic HTML shell with React root, Tailwind CDN.

**main.tsx:**
Entry point that:
1. Creates App instance with name 'CensusChat Bar Chart'
2. Sets ontoolresult handler to receive data
3. Auto-detects chart configuration from data shape
4. Renders BarChart + ExportControls
5. Calls app.connect()

Auto-detection logic for chart config:
- X-axis: First string column (typically name/region)
- Y-axes: All numeric columns (population, income, etc.)
- If no clear string column, use first column as X

**BarChart.tsx:**
Recharts-based bar chart component.

Props:
```typescript
interface BarChartProps {
  data: any[];
  xAxisKey: string;
  yAxisKeys: string[];
  title?: string;
  onBarClick?: (data: any) => void;
}
```

Implementation:
1. Use Recharts components: BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend
2. Wrap in ResponsiveContainer with min-height (400px)
3. Configure colors from palette (8884d8, 82ca9d, ffc658, ff7c43...)
4. Format axis labels (truncate long names, format numbers)
5. Tooltip shows full values with number formatting
6. Legend identifies each bar series
7. Optional onClick for bar click handling (drill-down)

Styling:
- Outer container with min-h-[400px]
- Responsive width (100%)
- Clear grid lines with strokeDasharray="3 3"
- Professional color palette

Add ExportControls below chart:
```tsx
<ExportControls
  data={data}
  columns={[xAxisKey, ...yAxisKeys].map(k => ({ id: k, header: k }))}
  defaultFilename="census-chart-data"
/>
```

**Update mcp-apps/vite.config.ts for multi-app build:**
Update to build all three apps (data-table, bar-chart, line-chart):

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { viteSingleFile } from 'vite-plugin-singlefile';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react(), viteSingleFile()],
  build: {
    target: 'esnext',
    assetsInlineLimit: 100000000,
    cssCodeSplit: false,
    rollupOptions: {
      input: {
        'data-table': resolve(__dirname, 'src/data-table/index.html'),
        'bar-chart': resolve(__dirname, 'src/bar-chart/index.html'),
        'line-chart': resolve(__dirname, 'src/line-chart/index.html'),
      },
      output: {
        dir: '../backend/src/mcp/mcpApps',
        entryFileNames: '[name].js',
      },
    },
  },
});
```
  </action>
  <verify>
```bash
ls mcp-apps/src/bar-chart/
grep -l "BarChart" mcp-apps/src/bar-chart/BarChart.tsx
grep -l "ResponsiveContainer" mcp-apps/src/bar-chart/BarChart.tsx
grep -l "ExportControls" mcp-apps/src/bar-chart/main.tsx || grep -l "ExportControls" mcp-apps/src/bar-chart/BarChart.tsx
grep -l "bar-chart" mcp-apps/vite.config.ts
grep -l "line-chart" mcp-apps/vite.config.ts
```
  </verify>
  <done>
Bar chart MCP App source exists with Recharts BarChart and ExportControls, Vite config updated for multi-app build
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Line Chart MCP App and build all charts</name>
  <files>
    mcp-apps/src/line-chart/index.html
    mcp-apps/src/line-chart/main.tsx
    mcp-apps/src/line-chart/LineChart.tsx
    backend/src/mcp/mcpApps/bar-chart.html
    backend/src/mcp/mcpApps/line-chart.html
    backend/src/mcp/mcpServer.ts
  </files>
  <action>
**Line Chart MCP App (similar structure to bar chart):**

**index.html:** Basic HTML shell.

**main.tsx:**
- Create App instance 'CensusChat Line Chart'
- Auto-detect time column (year, date, month) for X-axis
- Render LineChart + ExportControls

**LineChart.tsx:**
Props similar to BarChart but for line visualization.

Implementation:
1. Use Recharts: LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend
2. ResponsiveContainer wrapper
3. Multiple Line components for multiple Y series
4. Stroke colors from same palette as bar chart
5. Dot markers on data points (optional based on data density)
6. activeDot for hover highlighting

**Build all MCP Apps:**
Run build:
```bash
cd mcp-apps && npm run build
```

This uses the updated vite.config.ts from Task 2 to build all three apps.

**Update MCP server for chart tools:**
Add chart-specific tools that return with chart UI resources:

```typescript
// Add alongside execute_query
server.tool(
  'execute_comparison_query',
  'Execute a query for demographic comparison (returns bar chart)',
  {
    query: z.string().describe('SQL query comparing regions/demographics')
  },
  async (args) => {
    // Use existing handleExecuteQuery logic
    // Return with ui: resourceUri pointing to bar-chart.html
  }
);

server.tool(
  'execute_trend_query',
  'Execute a query for trend analysis (returns line chart)',
  {
    query: z.string().describe('SQL query with time-series data')
  },
  async (args) => {
    // Use existing handleExecuteQuery logic
    // Return with ui: resourceUri pointing to line-chart.html
  }
);
```

**Query type detection heuristic:**
For auto-selecting chart type based on query results:
- Contains time column (year, date, month) + numeric -> line chart
- Contains geographic/categorical + numeric comparisons -> bar chart
- Default -> data table

This can be used by Claude to select appropriate tools.
  </action>
  <verify>
```bash
ls mcp-apps/src/line-chart/
ls backend/src/mcp/mcpApps/
# Should show data-table.html, bar-chart.html, line-chart.html
wc -c backend/src/mcp/mcpApps/*.html  # All should exist with reasonable sizes
grep -n "execute_comparison_query\|execute_trend_query" backend/src/mcp/mcpServer.ts
cd backend && npm run typecheck
```
  </verify>
  <done>
Line chart source exists, all three MCP Apps built to mcpApps directory, chart-specific tools registered
  </done>
</task>

</tasks>

<verification>
1. ExportControls exists: `ls mcp-apps/src/shared/ExportControls.tsx`
2. CSV export works: `grep "convertToCSV" mcp-apps/src/shared/exportUtils.ts`
3. Bar chart source: `ls mcp-apps/src/bar-chart/BarChart.tsx`
4. Line chart source: `ls mcp-apps/src/line-chart/LineChart.tsx`
5. Built apps exist: `ls backend/src/mcp/mcpApps/*.html`
6. Chart tools registered: `grep "execute_comparison_query" backend/src/mcp/mcpServer.ts`
7. TypeScript compiles: `cd backend && npm run typecheck`
</verification>

<success_criteria>
- ExportControls component with format selector and column picker
- CSV export generates locally and triggers download
- Excel export sends message to host
- Bar chart renders with Recharts BarChart + ResponsiveContainer
- Line chart renders with Recharts LineChart
- Both charts auto-detect axes from data shape
- All three MCP Apps (data-table, bar-chart, line-chart) built to backend/src/mcp/mcpApps/
- Chart-specific MCP tools registered (execute_comparison_query, execute_trend_query)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-interactive-ui-layer/03-03-SUMMARY.md`
</output>
