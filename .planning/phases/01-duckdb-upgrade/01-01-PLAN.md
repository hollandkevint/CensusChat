---
phase: 01-duckdb-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/utils/duckdbPool.ts
  - backend/src/__tests__/utils/duckdbPool.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Application imports from @duckdb/node-api not duckdb"
    - "DuckDBPool uses native Promises, no callbacks"
    - "Pool uses DuckDBInstance.fromCache() for singleton management"
    - "All existing pool tests pass with new API mocks"
  artifacts:
    - path: "backend/src/utils/duckdbPool.ts"
      provides: "New async API pool implementation"
      exports: ["DuckDBPool", "DuckDBPoolConfig", "PoolStats", "getDuckDBPool", "closeDuckDBPool"]
      min_lines: 150
    - path: "backend/src/__tests__/utils/duckdbPool.test.ts"
      provides: "Updated tests for new API"
      contains: "@duckdb/node-api"
  key_links:
    - from: "backend/src/utils/duckdbPool.ts"
      to: "@duckdb/node-api"
      via: "import { DuckDBInstance, DuckDBConnection }"
      pattern: "from '@duckdb/node-api'"
    - from: "backend/src/utils/duckdbPool.ts"
      to: "DuckDBInstance"
      via: "fromCache() singleton pattern"
      pattern: "DuckDBInstance\\.fromCache"
---

<objective>
Upgrade DuckDB package and rewrite DuckDBPool for new async API.

Purpose: The deprecated `duckdb` npm package must be replaced with `@duckdb/node-api` before any other DuckDB 1.4 features (encryption, MERGE, profiler) can be used. This is the foundation for all subsequent plans.

Output: Working DuckDBPool using native Promises, DuckDBInstance singleton via fromCache(), and passing test suite.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-duckdb-upgrade/01-RESEARCH.md

# Current implementation to rewrite
@backend/src/utils/duckdbPool.ts
@backend/src/__tests__/utils/duckdbPool.test.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace duckdb package with @duckdb/node-api</name>
  <files>backend/package.json</files>
  <action>
    1. Remove old duckdb package:
       ```bash
       cd backend && npm uninstall duckdb
       ```
    2. Install new package with exact version:
       ```bash
       npm install @duckdb/node-api@1.4.3-r.3
       ```
    3. Verify package.json shows `"@duckdb/node-api": "1.4.3-r.3"` in dependencies
    4. Run `npm install` to update package-lock.json

    DO NOT install both packages - the old `duckdb` package must be fully removed.
  </action>
  <verify>
    ```bash
    cd backend && cat package.json | grep -E '"duckdb"|"@duckdb/node-api"'
    ```
    Should show only `"@duckdb/node-api": "1.4.3-r.3"`, not `"duckdb"`.
  </verify>
  <done>package.json has @duckdb/node-api 1.4.3-r.3, no duckdb package present</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite DuckDBPool for new async API</name>
  <files>backend/src/utils/duckdbPool.ts</files>
  <action>
    Rewrite the entire DuckDBPool class using the new @duckdb/node-api patterns from RESEARCH.md:

    1. **Imports**: Change from `import { Database } from 'duckdb'` to:
       ```typescript
       import { DuckDBInstance, DuckDBConnection } from '@duckdb/node-api';
       ```

    2. **Instance management**: Replace `new Database(path)` with:
       ```typescript
       this.instance = await DuckDBInstance.fromCache(this.config.dbPath, {
         memory_limit: this.config.memoryLimit,
         threads: String(this.config.threads),
       });
       ```

    3. **Connection management**: Replace callback-based connection with:
       ```typescript
       const conn = await this.instance.connect();
       ```

    4. **Query execution**: Replace `db.all(sql, callback)` with:
       ```typescript
       const reader = await conn.runAndReadAll(sql);
       return reader.getRowObjects();
       ```

    5. **Configuration**: Replace callback-based `db.run()` with:
       ```typescript
       await conn.run('SET memory_limit = ...');
       await conn.run('INSTALL httpfs; LOAD httpfs;');
       ```

    6. **Cleanup**: Replace `connection.close(callback)` with:
       ```typescript
       conn.disconnectSync();
       this.instance?.closeSync();
       ```

    7. **Remove MCP extension loading** from createConnection - the duckdb_mcp extension doesn't exist in 1.4 and was causing warnings. Only load httpfs and spatial.

    Keep the same public interface: DuckDBPoolConfig, PoolStats, acquire(), release(), query(), close(), getStats(), healthCheck().

    Remove validateMCPExtension() method - not needed with new architecture.

    See RESEARCH.md "Complete Pool Rewrite" example for full implementation pattern.
  </action>
  <verify>
    ```bash
    cd backend && npm run typecheck
    ```
    Should complete with no errors. Imports should resolve to @duckdb/node-api types.
  </verify>
  <done>DuckDBPool uses DuckDBInstance.fromCache(), native Promises, runAndReadAll() for queries, disconnectSync() for cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Update pool tests for new API mocks</name>
  <files>backend/src/__tests__/utils/duckdbPool.test.ts</files>
  <action>
    Update the test mocks to match new @duckdb/node-api patterns:

    1. **Change mock import** from `import { Database } from 'duckdb'` to:
       ```typescript
       import { DuckDBInstance, DuckDBConnection } from '@duckdb/node-api';
       ```

    2. **Replace jest.mock('duckdb')** with mock for new API:
       ```typescript
       jest.mock('@duckdb/node-api', () => ({
         DuckDBInstance: {
           fromCache: jest.fn().mockResolvedValue({
             connect: jest.fn().mockResolvedValue({
               run: jest.fn().mockResolvedValue(undefined),
               runAndReadAll: jest.fn().mockResolvedValue({
                 getRowObjects: jest.fn().mockReturnValue([{ test: 1 }])
               }),
               disconnectSync: jest.fn()
             }),
             closeSync: jest.fn()
           })
         }
       }));
       ```

    3. **Update connection type references** from `Database` to `DuckDBConnection`

    4. **Update query assertions** to use new mock structure (getRowObjects instead of callback)

    5. **Keep all existing test cases** - they test pool logic, not DuckDB internals

    6. **Remove timeout test** that relied on callback never firing - new API uses Promises with natural timeout behavior
  </action>
  <verify>
    ```bash
    cd backend && npm test -- --testPathPattern="duckdbPool.test.ts" --verbose
    ```
    All tests should pass.
  </verify>
  <done>All pool tests pass with new @duckdb/node-api mocks</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compiles cleanly:**
   ```bash
   cd backend && npm run typecheck
   ```

2. **All pool tests pass:**
   ```bash
   cd backend && npm test -- --testPathPattern="duckdbPool.test.ts"
   ```

3. **No old duckdb references remain:**
   ```bash
   grep -r "from 'duckdb'" backend/src/utils/duckdbPool.ts
   ```
   Should return nothing.

4. **Package.json correct:**
   ```bash
   cat backend/package.json | grep -E '"duckdb"|"@duckdb/node-api"'
   ```
   Should show only @duckdb/node-api.
</verification>

<success_criteria>
- @duckdb/node-api 1.4.3-r.3 installed, old duckdb package removed
- DuckDBPool uses DuckDBInstance.fromCache() for singleton
- All query methods use runAndReadAll() with getRowObjects()
- All connection cleanup uses disconnectSync()
- TypeScript compiles without errors
- All existing pool tests pass with updated mocks
</success_criteria>

<output>
After completion, create `.planning/phases/01-duckdb-upgrade/01-01-SUMMARY.md`
</output>
