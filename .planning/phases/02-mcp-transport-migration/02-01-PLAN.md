---
phase: 02-mcp-transport
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/mcp/mcpServer.ts
  - backend/src/mcp/mcpSessionManager.ts
  - backend/src/mcp/mcpRoutes.ts
autonomous: true

must_haves:
  truths:
    - "MCP SDK 1.25.3 installed and TypeScript compiles without errors"
    - "POST /mcp creates new session on initialize request"
    - "POST /mcp with session ID routes to existing session"
    - "GET /mcp returns SSE stream for established session"
    - "DELETE /mcp terminates session and cleans up resources"
  artifacts:
    - path: "backend/src/mcp/mcpSessionManager.ts"
      provides: "Session storage and lifecycle management"
      exports: ["McpSessionManager", "getSessionManager"]
    - path: "backend/src/mcp/mcpServer.ts"
      provides: "StreamableHTTPServerTransport-based MCP server"
      exports: ["createMcpServer", "getMcpServerForSession"]
    - path: "backend/src/mcp/mcpRoutes.ts"
      provides: "Express router for /mcp endpoints"
      exports: ["mcpTransportRouter"]
  key_links:
    - from: "backend/src/mcp/mcpRoutes.ts"
      to: "backend/src/mcp/mcpSessionManager.ts"
      via: "getSessionManager() for session lookup"
      pattern: "getSessionManager\\(\\)"
    - from: "backend/src/mcp/mcpRoutes.ts"
      to: "StreamableHTTPServerTransport"
      via: "transport.handleRequest() delegation"
      pattern: "handleRequest\\(req.*res"
---

<objective>
Upgrade MCP SDK to 1.25.3 and implement StreamableHTTPServerTransport with session management.

Purpose: Enable external MCP clients (Claude Desktop, Postman) to connect over HTTP instead of stdio.
Output: Working /mcp endpoint with POST/GET/DELETE handlers and session lifecycle management.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-mcp-transport-migration/02-RESEARCH.md

@backend/package.json
@backend/src/mcp/mcpServer.ts
@backend/src/validation/sqlValidator.ts
@backend/src/validation/sqlSecurityPolicies.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade SDK and create session manager</name>
  <files>
    backend/package.json
    backend/src/mcp/mcpSessionManager.ts
  </files>
  <action>
1. Upgrade MCP SDK:
   ```bash
   cd backend && npm install @modelcontextprotocol/sdk@1.25.3
   ```

2. Verify zod version is compatible (needs ^3.25.0 for SDK 1.25.x):
   ```bash
   npm ls zod
   ```
   If version mismatch, upgrade zod: `npm install zod@^3.25.0`

3. Create `backend/src/mcp/mcpSessionManager.ts`:
   - Export `McpSessionManager` class with:
     - `transports: Map<string, StreamableHTTPServerTransport>`
     - `servers: Map<string, McpServer>`
     - `createSession(sessionId: string): { transport, server }`
     - `getSession(sessionId: string): { transport, server } | undefined`
     - `deleteSession(sessionId: string): boolean`
     - `getSessionCount(): number`
   - Register cleanup on `transport.onClose`
   - Export singleton `getSessionManager()` function
   - Use `randomUUID` from `node:crypto` for session ID generation
   - Session TTL: 30 minutes with cleanup on disconnect

Import pattern (from RESEARCH.md):
```typescript
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js';
```
  </action>
  <verify>
    cd backend && npm run typecheck
    # Should compile without errors related to MCP SDK imports
  </verify>
  <done>
    - package.json shows @modelcontextprotocol/sdk@1.25.3
    - mcpSessionManager.ts exports McpSessionManager and getSessionManager
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite mcpServer.ts for HTTP transport</name>
  <files>
    backend/src/mcp/mcpServer.ts
  </files>
  <action>
Replace the existing StdioServerTransport implementation with StreamableHTTPServerTransport.

1. Remove imports for `StdioServerTransport`
2. Add imports:
   ```typescript
   import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
   import { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js';
   ```

3. Create factory function `createMcpServer(sessionId: string)`:
   - Instantiate `new McpServer({ name: 'censuschat-mcp-server', version: '1.0.0' })`
   - Register same tools as before:
     - `get_information_schema` - returns CENSUS_SCHEMA + security policy
     - `validate_sql_query` - validates SQL via getSQLValidator()
     - `execute_query` - validates then executes via getDuckDBPool()
   - Use `server.tool()` method (new API in 1.25.x, replaces `setRequestHandler`)
   - Return the server instance

4. Keep existing tool handler logic (handleGetInformationSchema, handleValidateSQLQuery, handleExecuteQuery) but refactor as standalone functions that can be called from tool registrations.

5. Remove the `start()` method that uses stdio transport - HTTP connection happens via routes.

6. Export:
   - `createMcpServer(sessionId: string): McpServer`
   - Keep `closeCensusChat_MCPServer()` for cleanup but update to close all sessions via session manager
  </action>
  <verify>
    cd backend && npm run typecheck
    # Verify no StdioServerTransport references remain
    grep -r "StdioServerTransport" backend/src/mcp/
  </verify>
  <done>
    - mcpServer.ts uses StreamableHTTPServerTransport imports
    - createMcpServer() factory function exported
    - Tool handlers preserved (get_information_schema, validate_sql_query, execute_query)
    - No StdioServerTransport references
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HTTP routes for MCP transport</name>
  <files>
    backend/src/mcp/mcpRoutes.ts
    backend/src/routes/index.ts
  </files>
  <action>
1. Create `backend/src/mcp/mcpRoutes.ts`:

```typescript
import { Router, Request, Response } from 'express';
import { isInitializeRequest } from '@modelcontextprotocol/sdk/types.js';
import { getSessionManager } from './mcpSessionManager';
import { createMcpServer } from './mcpServer';

const router = Router();

// POST /mcp - Handle JSON-RPC requests
router.post('/', async (req: Request, res: Response) => {
  const sessionId = req.headers['mcp-session-id'] as string | undefined;
  const manager = getSessionManager();

  // Existing session
  if (sessionId) {
    const session = manager.getSession(sessionId);
    if (session) {
      await session.transport.handleRequest(req, res, req.body);
      return;
    }
    // Session not found
    res.status(400).json({
      jsonrpc: '2.0',
      error: { code: -32600, message: 'Invalid session ID' },
      id: null,
    });
    return;
  }

  // New initialization
  if (isInitializeRequest(req.body)) {
    const session = manager.createSession();
    await session.transport.handleRequest(req, res, req.body);
    return;
  }

  // Invalid request
  res.status(400).json({
    jsonrpc: '2.0',
    error: { code: -32600, message: 'Missing session ID or not an initialize request' },
    id: null,
  });
});

// GET /mcp - SSE stream
router.get('/', async (req: Request, res: Response) => {
  const sessionId = req.headers['mcp-session-id'] as string | undefined;

  if (!sessionId) {
    res.status(400).json({ error: 'Missing Mcp-Session-Id header' });
    return;
  }

  const session = getSessionManager().getSession(sessionId);
  if (!session) {
    res.status(400).json({ error: 'Invalid session ID' });
    return;
  }

  // SSE headers
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('X-Accel-Buffering', 'no');

  await session.transport.handleSseConnection(req, res);
});

// DELETE /mcp - Terminate session
router.delete('/', async (req: Request, res: Response) => {
  const sessionId = req.headers['mcp-session-id'] as string | undefined;

  if (!sessionId) {
    res.status(400).json({ error: 'Missing Mcp-Session-Id header' });
    return;
  }

  const deleted = getSessionManager().deleteSession(sessionId);
  if (!deleted) {
    res.status(404).json({ error: 'Session not found' });
    return;
  }

  res.status(204).send();
});

export { router as mcpTransportRouter };
```

2. Update `backend/src/routes/index.ts`:
   - Import `mcpTransportRouter` from '../mcp/mcpRoutes'
   - Mount at `/mcp` (NOT /api/v1/mcp - MCP clients expect /mcp at root)
   - Keep existing `mcpRoutes` at `/api/v1/mcp` for healthcare tools

Pattern:
```typescript
import { mcpTransportRouter } from '../mcp/mcpRoutes';

// MCP transport endpoints (protocol level)
app.use('/mcp', mcpTransportRouter);

// Healthcare MCP tools (application level) - keep existing
app.use('/api/v1/mcp', mcpRoutes);
```
  </action>
  <verify>
    cd backend && npm run typecheck
    cd backend && npm run build
    # Start server and test endpoints:
    curl -X POST http://localhost:3001/mcp \
      -H "Content-Type: application/json" \
      -H "Accept: application/json, text/event-stream" \
      -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","clientInfo":{"name":"test","version":"1.0.0"},"capabilities":{}}}'
    # Should return 200 with session ID in Mcp-Session-Id header
  </verify>
  <done>
    - mcpRoutes.ts exports mcpTransportRouter with POST/GET/DELETE handlers
    - Routes mounted at /mcp in routes/index.ts
    - POST /mcp returns session ID on initialize
    - GET /mcp returns SSE stream for valid session
    - DELETE /mcp terminates session
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation:
   ```bash
   cd backend && npm run typecheck && npm run build
   ```

2. Unit tests pass (existing tests may need updates):
   ```bash
   cd backend && npm test -- --testPathPattern="mcp"
   ```

3. Manual endpoint test:
   ```bash
   # Start server
   cd backend && npm run dev &

   # Initialize session
   curl -i -X POST http://localhost:3001/mcp \
     -H "Content-Type: application/json" \
     -H "Accept: application/json, text/event-stream" \
     -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","clientInfo":{"name":"test","version":"1.0.0"},"capabilities":{}}}'

   # Capture session ID from response header, use for subsequent requests
   ```
</verification>

<success_criteria>
- MCP SDK upgraded to 1.25.3
- Session manager tracks active sessions with cleanup
- /mcp endpoints respond correctly:
  - POST creates session on initialize, routes to session otherwise
  - GET returns SSE stream
  - DELETE terminates session
- Existing MCP tools (get_information_schema, validate_sql_query, execute_query) work via HTTP
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-transport-migration/02-01-SUMMARY.md`
</output>
